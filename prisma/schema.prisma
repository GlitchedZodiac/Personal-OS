generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model FoodLog {
  id              String   @id @default(uuid())
  loggedAt        DateTime @default(now())
  mealType        String   // breakfast, lunch, dinner, snack
  foodDescription String
  calories        Float    @default(0)
  proteinG        Float    @default(0)
  carbsG          Float    @default(0)
  fatG            Float    @default(0)
  notes           String?
  source          String   @default("manual") // manual, voice, ai
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([loggedAt])
  @@map("food_logs")
}

model BodyMeasurement {
  id           String   @id @default(uuid())
  measuredAt   DateTime @default(now())
  weightKg     Float?
  bodyFatPct   Float?
  waistCm      Float?
  chestCm      Float?
  armsCm       Float?
  legsCm       Float?
  hipsCm       Float?
  shouldersCm  Float?
  neckCm       Float?
  forearmsCm   Float?
  calvesCm     Float?
  skinfoldData Json?    // { chest, abdomen, thigh, triceps, suprailiac, subscapular, midaxillary } in mm
  notes        String?

  // Smart scale fields (VeSync / body composition)
  bmi               Float?
  fatFreeWeightKg   Float?
  subcutaneousFatPct Float?
  visceralFat       Int?
  bodyWaterPct      Float?
  skeletalMusclePct Float?
  muscleMassKg      Float?
  boneMassKg        Float?
  proteinPct        Float?
  bmrKcal           Int?
  metabolicAge      Int?
  heartRateBpm      Int?
  source            String?  // "manual", "vesync", "import"

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([measuredAt])
  @@map("body_measurements")
}

model WorkoutLog {
  id              String   @id @default(uuid())
  startedAt       DateTime @default(now())
  durationMinutes Int      @default(0)
  workoutType     String   // strength, cardio, walk, run, cycling, etc.
  description     String?
  caloriesBurned  Float?
  exercises       Json?    // Array of { name, sets, reps, weight }
  stravaActivityId String?
  source          String   @default("manual") // manual, voice, strava
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([startedAt])
  @@map("workout_logs")
}

model WaterLog {
  id        String   @id @default(uuid())
  loggedAt  DateTime @default(now())
  amountMl  Int      @default(250) // milliliters per entry
  createdAt DateTime @default(now())

  @@index([loggedAt])
  @@map("water_logs")
}

model FavoriteFoods {
  id              String   @id @default(uuid())
  foodDescription String
  mealType        String
  calories        Float    @default(0)
  proteinG        Float    @default(0)
  carbsG          Float    @default(0)
  fatG            Float    @default(0)
  usageCount      Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("favorite_foods")
}

model WorkoutPlan {
  id            String   @id @default(uuid())
  name          String   // e.g. "4-Day Push/Pull/Legs"
  goal          String   // build_muscle, lose_weight, general_fitness, endurance
  fitnessLevel  String   // beginner, intermediate, advanced
  daysPerWeek   Int      @default(4)
  schedule      Json     // Array of day schedules with exercises
  isActive      Boolean  @default(true)
  aiGenerated   Boolean  @default(false)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  completions   WorkoutPlanCompletion[]

  @@map("workout_plans")
}

model WorkoutPlanCompletion {
  id                String       @id @default(uuid())
  planId            String
  plan              WorkoutPlan  @relation(fields: [planId], references: [id], onDelete: Cascade)
  scheduledDate     DateTime     // The date this workout was scheduled for
  dayIndex          Int          // Which day in the plan schedule (0-based)
  dayLabel          String       // "Day 1 - Push", "Day 2 - Pull", etc.
  completed         Boolean      @default(false)
  feedback          String?      // as_planned, exceeded, incomplete
  actualExercises   Json?        // What the user actually did (with actual weights/reps)
  caloriesBurned    Float?
  durationMinutes   Int?
  userNotes         String?
  aiSuggestion      String?      // AI's adjustment suggestion after feedback
  createdAt         DateTime     @default(now())

  @@unique([planId, scheduledDate, dayIndex])
  @@map("workout_plan_completions")
}

model Todo {
  id          String    @id @default(uuid())
  title       String
  notes       String?
  dueDate     DateTime? // optional due date
  completed   Boolean   @default(false)
  completedAt DateTime?
  priority    String    @default("normal") // low, normal, high
  icon        String?   // emoji icon assigned by AI (e.g. ğŸ“, ğŸ“§, ğŸ‹ï¸)
  category    String    @default("manual") // manual, app, recurring
  isRecurring Boolean   @default(false)
  recurrence  String?   // "daily", "weekdays", "weekly", "monthly"
  recurrenceParentId String? // links instances back to the template
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([completed, dueDate])
  @@index([dueDate])
  @@map("todos")
}

model AIConversation {
  id            String   @id @default(uuid())
  userMessage   String
  aiResponse    String
  actionTaken   String?  // food_logged, measurement_logged, workout_logged, etc.
  extractedData Json?
  createdAt     DateTime @default(now())

  @@map("ai_conversations")
}

model ProgressPhoto {
  id          String   @id @default(uuid())
  takenAt     DateTime @default(now())
  imageData   String   // base64 encoded compressed image
  journalNote String?  // optional journal/voice note
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("progress_photos")
}

model AIInsightCache {
  id          String   @id @default(uuid())
  cacheKey    String   @unique // e.g. "weekly_insight_2026-02-15"
  insight     String
  dataHash    String   // hash of input data to detect staleness
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("ai_insight_cache")
}

model UserSettings {
  id        String   @id @default("default") // single-user app, one row
  data      Json     // full AppSettings JSON
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("user_settings")
}

model Reminder {
  id          String    @id @default(uuid())
  title       String
  body        String?
  remindAt    DateTime  // when to fire the notification
  url         String    @default("/todos") // where to navigate on click
  fired       Boolean   @default(false)
  todoId      String?   // optional link to a todo
  createdAt   DateTime  @default(now())

  @@index([fired, remindAt])
  @@map("reminders")
}

model StravaToken {
  id            String   @id @default("default") // single-user app, one row
  athleteId     Int
  accessToken   String
  refreshToken  String
  expiresAt     Int      // unix timestamp
  scope         String   @default("activity:read_all")
  athleteName   String?
  athletePhoto  String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("strava_tokens")
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FINANCIAL MODULE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

model FinancialAccount {
  id           String   @id @default(uuid())
  name         String   // "Bancolombia Savings", "Nequi", "Credit Card X"
  accountType  String   // checking, savings, credit_card, cash, investment, loan
  currency     String   @default("COP") // ISO 4217
  balance      Float    @default(0) // current balance (updated manually or via sync)
  creditLimit  Float?   // for credit cards
  interestRate Float?   // for loans/credit cards (APR %)
  institution  String?  // "Bancolombia", "Nequi", "Davivienda"
  lastSyncedAt DateTime? // last time data was synced/imported
  isActive     Boolean  @default(true)
  color        String?  // hex color for UI
  icon         String?  // emoji icon
  notes        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  transactions FinancialTransaction[]

  @@map("financial_accounts")
}

model FinancialTransaction {
  id            String   @id @default(uuid())
  accountId     String
  account       FinancialAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)
  transactedAt  DateTime @default(now()) // when the transaction occurred
  amount        Float    // positive = income, negative = expense
  currency      String   @default("COP")
  description   String   // "Ã‰xito grocery", "Spotify subscription"
  category      String   // food, transport, housing, entertainment, income, transfer, etc.
  subcategory   String?  // "groceries", "dining_out", "salary", "freelance"
  type          String   // income, expense, transfer
  isRecurring   Boolean  @default(false) // subscription, rent, salary
  merchant      String?  // extracted merchant name
  reference     String?  // bank reference number
  notes         String?
  source        String   @default("manual") // manual, csv_import, voice, ai, belvo, email
  tags          String?  // comma-separated tags
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([transactedAt])
  @@index([accountId])
  @@index([category])
  @@map("financial_transactions")
}

model BudgetCategory {
  id            String   @id @default(uuid())
  name          String   // "Food & Groceries", "Transport", "Entertainment"
  icon          String?  // emoji
  color         String?  // hex color
  type          String   @default("expense") // expense, income, savings
  parentId      String?  // for subcategories
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  budgetItems   BudgetItem[]

  @@map("budget_categories")
}

model Budget {
  id          String   @id @default(uuid())
  name        String   // "February 2026", "Monthly Budget"
  month       Int      // 1-12
  year        Int      // 2026
  totalIncome Float    @default(0) // planned total income
  totalBudget Float    @default(0) // planned total expenses
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items       BudgetItem[]

  @@unique([month, year])
  @@map("budgets")
}

model BudgetItem {
  id            String   @id @default(uuid())
  budgetId      String
  budget        Budget   @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  categoryId    String
  category      BudgetCategory @relation(fields: [categoryId], references: [id])
  planned       Float    @default(0) // desired/budgeted amount
  isFixed       Boolean  @default(false) // rent, loan payments = fixed; food, entertainment = variable
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([budgetId, categoryId])
  @@map("budget_items")
}

model RecurringTransaction {
  id            String   @id @default(uuid())
  accountId     String?
  description   String   // "Netflix", "Rent", "Salary"
  amount        Float
  currency      String   @default("COP")
  category      String
  type          String   // income, expense
  frequency     String   // monthly, biweekly, weekly, yearly
  dayOfMonth    Int?     // 1-31 for monthly
  nextDueDate   DateTime
  isActive      Boolean  @default(true)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("recurring_transactions")
}

model SavingsGoal {
  id            String   @id @default(uuid())
  name          String   // "Emergency Fund", "Vacation", "New Laptop"
  targetAmount  Float
  currentAmount Float    @default(0)
  currency      String   @default("COP")
  deadline      DateTime?
  icon          String?  // emoji
  color         String?  // hex
  isCompleted   Boolean  @default(false)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("savings_goals")
}
